<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF è«®è©¢å–®ï¼ˆé€é¡Œï¼‰</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{--card:#fff;--bg:#f6f7f9;--primary:#16a34a}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:720px;margin:24px auto;padding:16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:20px}
    .progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin:8px 0 20px}
    .bar{height:100%;background:var(--primary);width:0%}
    h1{font-size:22px;margin:8px 0 16px}
    .q{display:none}
    .q.active{display:block}
    .field{margin:14px 0}
    label{display:block;margin-bottom:6px;color:#374151}
    input[type=text],input[type=tel],input[type=email],textarea,select{
      width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;box-sizing:border-box
    }
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .actions{display:flex;gap:12px;justify-content:space-between;margin-top:16px}
    button{border:0;border-radius:999px;padding:12px 18px;font-weight:600;cursor:pointer}
    .ghost{background:#eef2ff}
    .primary{background:var(--primary);color:white}
    .hint{color:#6b7280;font-size:13px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip input{display:none}
    .chip label{border:1px solid #e5e7eb;border-radius:999px;padding:8px 12px;cursor:pointer}
    .chip input:checked + label{background:#dcfce7;border-color:#86efac}
    .previews{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .previews img{width:96px;height:96px;object-fit:cover;border-radius:12px;border:1px solid #e5e7eb}
    .error{color:#b91c1c;font-size:13px;margin-top:6px}
    .ok{color:#065f46;font-size:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>è«®è©¢å•å·</h1>
      <div class="progress"><div class="bar" id="bar"></div></div>
      <p class="hint" id="hello">åˆå§‹åŒ–ä¸­â€¦</p>

      <!-- Q1ï¼šåŸºæœ¬è¨´æ±‚ -->
      <section class="q active" data-required="true">
        <div class="field">
          <label>ä½ æ­¤åˆ»æœ€æƒ³æ”¹å–„çš„ç›®æ¨™æ˜¯ï¼Ÿ</label>
          <div class="chips">
            <div class="chip"><input type="radio" name="goal" id="g1" value="æ¸›è„‚"><label for="g1">æ¸›è„‚</label></div>
            <div class="chip"><input type="radio" name="goal" id="g2" value="å¢è‚Œ"><label for="g2">å¢è‚Œ</label></div>
            <div class="chip"><input type="radio" name="goal" id="g3" value="é«”æ…‹é›•å¡‘"><label for="g3">é«”æ…‹é›•å¡‘</label></div>
            <div class="chip"><input type="radio" name="goal" id="g4" value="æ”¹å–„ç— ç—›/å§¿å‹¢"><label for="g4">æ”¹å–„ç— ç—›/å§¿å‹¢</label></div>
          </div>
          <div class="error" data-error></div>
        </div>
      </section>

      <!-- Q2ï¼šæ™‚é–“èˆ‡é »ç‡ -->
      <section class="q" data-required="true">
        <div class="field">
          <label>æ¯é€±å¯å®‰æ’çš„é‹å‹•æ¬¡æ•¸ï¼Ÿ</label>
          <select name="weekly_times" required>
            <option value="">è«‹é¸æ“‡</option>
            <option>1 æ¬¡</option><option>2 æ¬¡</option><option>3 æ¬¡</option>
            <option>4 æ¬¡</option><option>5 æ¬¡ä»¥ä¸Š</option>
          </select>
          <div class="error" data-error></div>
        </div>
      </section>

      <!-- Q3ï¼šèº«é«”ç‹€æ³ -->
      <section class="q" data-required="false">
        <div class="field">
          <label>æ˜¯å¦æœ‰é†«å¸«è¨ºæ–·æˆ–éœ€æ³¨æ„çš„èº«é«”ç‹€æ³ï¼Ÿï¼ˆé¸å¡«ï¼‰</label>
          <textarea name="health_note" placeholder="ä¾‹å¦‚ï¼šä¸‹èƒŒç— ç—›ã€è†è“‹èˆŠå‚·â€¦"></textarea>
        </div>
      </section>

      <!-- Q4ï¼šä¸Šå‚³åƒè€ƒç…§ç‰‡ï¼ˆé¸å¡«ï¼‰ -->
      <section class="q" data-required="false">
        <div class="field">
          <label>ä¸Šå‚³åƒè€ƒç…§ç‰‡ï¼ˆæœ€å¤š 3 å¼µï¼Œæ”¯æ´ jpg/pngï¼Œå–®å¼µ â‰¤ 3MBï¼‰</label>
          <input type="file" id="photos" accept="image/*" multiple />
          <div class="previews" id="previews"></div>
          <p class="hint">* è‹¥ä¹‹å¾Œè¦æ­£å¼è¿½è¹¤ï¼Œæˆ‘å€‘æœƒæä¾›æ›´æ¨™æº–çš„æ‹æ”æŒ‡å¼•ã€‚</p>
          <div class="error" data-error></div>
        </div>
      </section>

      <!-- Q5ï¼šè¯çµ¡è³‡è¨Š -->
      <section class="q" data-required="true">
        <div class="row">
          <div class="field">
            <label>å§“å</label>
            <input type="text" name="name" placeholder="ç‹å°æ˜" required/>
            <div class="error" data-error></div>
          </div>
          <div class="field">
            <label>æ‰‹æ©Ÿ</label>
            <input type="tel" name="phone" placeholder="09xxxxxxxx" required/>
            <div class="error" data-error></div>
          </div>
        </div>
        <div class="field">
          <label>Emailï¼ˆé¸å¡«ï¼‰</label>
          <input type="email" name="email" placeholder="you@email.com"/>
        </div>
      </section>

      <!-- å®Œæˆé  -->
      <section class="q" data-required="false">
        <p>ç¢ºèªé€å‡ºå¾Œï¼Œæˆ‘å€‘æœƒæŠŠçµæœå»ºç«‹æˆè«®è©¢ç´€éŒ„ä¸¦é€šçŸ¥æ•™ç·´/ç‡Ÿé¤Šå¸«èˆ‡ä½ è¯ç¹«ã€‚</p>
        <ul id="checklist" class="hint"></ul>
      </section>

      <div class="actions">
        <button class="ghost" id="prev" disabled>ä¸Šä¸€æ­¥</button>
        <div style="display:flex;gap:8px">
          <button class="ghost" id="saveDraft" type="button">æš«å­˜</button>
          <button class="primary" id="next">ä¸‹ä¸€æ­¥</button>
          <button class="primary" id="submit" style="display:none">é€å‡º</button>
        </div>
      </div>

      <p id="status" class="hint"></p>

      <!-- éš±è—æ¬„ä½ï¼šä¾†è‡ª LIFF -->
      <input type="hidden" id="line_user_id"/>
      <input type="hidden" id="line_display_name"/>
      <input type="hidden" id="line_email"/>
    </div>
  </div>

  <script>
    const LIFF_ID = "2007947083-NmVXjgWZ";                // â† æ›æˆä½ çš„
    const WEBHOOK_URL = "https://hook.us2.make.com/rshs73yehvhin83lp4hhq6lu6jv9fysh"; // â† æ›æˆ Make Webhook æˆ–ä½ çš„ API

    // -------- LIFF åˆå§‹åŒ– --------
    (async function initLIFF(){
      try{
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()){ liff.login(); return; }
        const profile = await liff.getProfile();
        const idToken = liff.getDecodedIDToken?.();

        document.getElementById("hello").textContent =
          `å—¨ ${profile.displayName}ï¼Œè«‹èŠ± 1~2 åˆ†é˜å®Œæˆè«®è©¢ã€‚`;

        document.getElementById("line_user_id").value = profile.userId;
        document.getElementById("line_display_name").value = profile.displayName;
        if (idToken?.email) document.getElementById("line_email").value = idToken.email;
      }catch(e){
        // é LIFF ç’°å¢ƒä¹Ÿå¯æ¸¬è©¦
        document.getElementById("hello").textContent =
          "ï¼ˆé LIFF æ¸¬è©¦æ¨¡å¼ï¼‰è«‹ç…§å¸¸å¡«å¯«ï¼Œé€å‡ºä»å¯æˆåŠŸã€‚";
        console.warn("LIFF init failed (testing out of LINE):", e);
      }
    })();

    // -------- è¡¨å–®é‚è¼¯ï¼šå¤šæ­¥é©Ÿ --------
    const $qs = Array.from(document.querySelectorAll(".q"));
    const $bar = document.getElementById("bar");
    const $prev = document.getElementById("prev");
    const $next = document.getElementById("next");
    const $submit = document.getElementById("submit");
    const $status = document.getElementById("status");
    const $checklist = document.getElementById("checklist");

    let step = 0;
    const LAST_STEP = $qs.length - 1;

    function showStep(i){
      $qs.forEach((el,idx)=>el.classList.toggle("active", idx===i));
      $prev.disabled = i===0;
      $next.style.display  = (i===LAST_STEP)? "none":"inline-block";
      $submit.style.display= (i===LAST_STEP)? "inline-block":"none";
      $bar.style.width = Math.round(((i+1)/$qs.length)*100) + "%";
      $status.textContent = "";
      if(i===LAST_STEP) summarize();
    }

    function summarize(){
      const fd = collectData(false);
      const items = [
        ["ç›®æ¨™", fd.goal || "â€”"],
        ["é »ç‡", fd.weekly_times || "â€”"],
        ["èº«é«”ç‹€æ³", fd.health_note || "â€”"],
        ["å§“å", fd.name || "â€”"],
        ["æ‰‹æ©Ÿ", fd.phone || "â€”"],
        ["Email", fd.email || "â€”"],
        ["åœ–ç‰‡å¼µæ•¸", (fd._photoFiles?.length||0) + " å¼µ"],
      ];
      $checklist.innerHTML = items.map(([k,v])=>`<li>${k}ï¼š${String(v).replace(/</g,"&lt;")}</li>`).join("");
    }

    function validate(i){
      const q = $qs[i];
      const required = q.dataset.required === "true";
      const err = q.querySelector("[data-error]");
      if(err) err.textContent = "";

      if(!required) return true;

      // æœ€ç°¡é©—è­‰ï¼šçœ‹æœ‰ç„¡å¿…å¡«å€¼
      const radios = q.querySelectorAll("input[type=radio]");
      if(radios.length){
        const checked = q.querySelector("input[type=radio]:checked");
        if(!checked){ if(err) err.textContent = "è«‹é¸æ“‡ä¸€é …"; return false; }
        return true;
      }
      const selects = q.querySelectorAll("select[required]");
      for(const s of selects){ if(!s.value){ if(err) err.textContent = "è«‹é¸æ“‡"; return false; } }

      const inputs = q.querySelectorAll("input[required], textarea[required]");
      for(const i of inputs){ if(!i.value.trim()){ if(err) err.textContent = "æ­¤æ¬„ä½ç‚ºå¿…å¡«"; return false; } }

      return true;
    }

    $prev.addEventListener("click",()=>{ if(step>0){ step--; showStep(step); }});
    $next.addEventListener("click",()=>{
      if(!validate(step)) return;
      if(step < LAST_STEP){ step++; showStep(step); }
    });

    // -------- æš«å­˜ï¼ˆlocalStorageï¼‰--------
    const KEY="consult_draft_v1";
    document.getElementById("saveDraft").addEventListener("click", ()=>{
      const data = collectData(false);
      localStorage.setItem(KEY, JSON.stringify(data));
      $status.innerHTML = "å·²æš«å­˜è‡³æœ¬æ©Ÿ âœ…";
    });
    (function loadDraft(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return;
        const data = JSON.parse(raw);
        if(data.goal) document.querySelector(`input[name=goal][value="${data.goal}"]`)?.click();
        if(data.weekly_times) document.querySelector("select[name=weekly_times]").value = data.weekly_times;
        if(data.health_note) document.querySelector("textarea[name=health_note]").value = data.health_note;
        if(data.name) document.querySelector("input[name=name]").value = data.name;
        if(data.phone) document.querySelector("input[name=phone]").value = data.phone;
        if(data.email) document.querySelector("input[name=email]").value = data.email;
      }catch(e){}
    })();

    // -------- åœ–ç‰‡è™•ç†ï¼ˆé è¦½ï¼‹é™åˆ¶ï¼‰--------
    const MAX_FILES = 3, MAX_MB = 3;
    const $photos = document.getElementById("photos");
    const $previews = document.getElementById("previews");
    $photos.addEventListener("change", ()=>{
      $previews.innerHTML="";
      const files = Array.from($photos.files||[]);
      const limited = files.slice(0, MAX_FILES);
      const overs = files.length - limited.length;
      if(overs>0) $status.textContent = `åªæœƒä¿ç•™å‰ ${MAX_FILES} å¼µã€‚`;

      for(const f of limited){
        if(f.size > MAX_MB*1024*1024){
          $status.textContent = `æœ‰åœ–ç‰‡è¶…é ${MAX_MB}MBï¼Œè«‹å£“ç¸®å¾Œå†è©¦ã€‚`;
          continue;
        }
        const url = URL.createObjectURL(f);
        const img = new Image(); img.src = url;
        $previews.appendChild(img);
      }
    });

    // -------- æ”¶é›†è³‡æ–™ --------
    function collectData(withFiles=true){
      const fd = {};
      const checked = document.querySelector("input[name=goal]:checked");
      fd.goal = checked?.value || "";
      fd.weekly_times = document.querySelector("select[name=weekly_times]")?.value || "";
      fd.health_note = document.querySelector("textarea[name=health_note]")?.value || "";
      fd.name = document.querySelector("input[name=name]")?.value || "";
      fd.phone = document.querySelector("input[name=phone]")?.value || "";
      fd.email = document.querySelector("input[name=email]")?.value || "";

      fd.line_user_id = document.getElementById("line_user_id").value || "";
      fd.line_display_name = document.getElementById("line_display_name").value || "";
      fd.line_email = document.getElementById("line_email").value || "";

      if(withFiles){
        fd._photoFiles = Array.from($photos.files||[]).slice(0,MAX_FILES)
          .filter(f=>f.size<=MAX_MB*1024*1024);
      }
      return fd;
    }

    // -------- é€å‡ºï¼ˆmultipart/form-dataï¼‰--------
    document.getElementById("submit").addEventListener("click", async ()=>{
      if(!validate(step)) return;

      const data = collectData(true);
      const form = new FormData();
      for(const [k,v] of Object.entries(data)){
        if(k==="_photoFiles") continue;
        form.append(k, v ?? "");
      }
      (data._photoFiles||[]).forEach((f,idx)=>form.append(`photo_${idx+1}`, f, f.name));

      $status.textContent = "å‚³é€ä¸­â€¦";
      try{
        const res = await fetch(WEBHOOK_URL, { method:"POST", body: form });
        if(!res.ok) throw new Error(await res.text().catch(()=>res.statusText));
        localStorage.removeItem(KEY);
        $status.innerHTML = "<span class='ok'>å·²é€å‡ºï¼æ„Ÿè¬ä½ çš„å¡«å¯«ï¼Œæˆ‘å€‘å°‡ç›¡å¿«èˆ‡ä½ è¯ç¹«ã€‚</span>";
        // è‹¥åœ¨èŠå¤©å…§ï¼Œå¯é¸æ“‡å›å‚³è¨Šæ¯
        if(liff?.isInClient?.()){
          try{
            await liff.sendMessages([{ type:"text", text:"æˆ‘å·²å®Œæˆè«®è©¢å–® ğŸ™Œ" }]);
          }catch(_){}
        }
      }catch(e){
        console.error(e);
        $status.innerHTML = `<span class='error'>é€å‡ºå¤±æ•—ï¼š${e.message}</span>`;
      }
    });

    // èµ·å§‹
    showStep(step);
  </script>
</body>
</html>
